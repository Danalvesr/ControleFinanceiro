<!DOCTYPE html>
<html lang="pt-BR">
<head>
    <meta charset="UTF-8">
    <link rel="shortcut icon" href="favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Controle Financeiro</title>
    <link rel="manifest" href="manifest.json">
    <script src="https://cdn.jsdelivr.net/npm/@tailwindcss/browser@4"></script>
    <script type="module">
        import { createClient } from 'https://esm.sh/@supabase/supabase-js@2';

        // Registro do Service Worker
        if ('serviceWorker' in navigator) {
            window.addEventListener('load', () => {
                navigator.serviceWorker.register('service-worker.js').then(registration => {
                    console.log('Service Worker registrado com sucesso:', registration);
                }).catch(err => {
                    console.log('Falha ao registrar o Service Worker:', err);
                });
            });
        }

        // SUBSTITUA ESTES VALORES COM OS SEUS DADOS DO SUPABASE
        const SUPABASE_URL = 'https://aroqdeuadpxypzgmfgld.supabase.co';
        const SUPABASE_ANON_KEY = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6ImFyb3FkZXVhZHB4eXB6Z21mZ2xkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NTY0ODg5MjUsImV4cCI6MjA3MjA2NDkyNX0.v3bt4YuCgzk2Y2f3uXZqsTvVzNbFHPbJUFd49F3W4NE';

        let supabase;
        // O nome da tabela agora é fixo, sem o appId, conforme solicitado.
        const tableNames = {
            receitas: 'receitas',
            despesas: 'despesas',
            investimentos: 'investimentos'
        };

        const appData = {
            receitas: [],
            despesas: [],
            investimentos: []
        };
        let allRecords = [];

        // Estado para controlar a ordenação de cada tabela
        const sortState = {
            column: 'created_at', 
            direction: 'desc'
        };

        function initializeSupabase() {
            try {
                // Tenta criar o cliente Supabase. Se as chaves não forem válidas, a conexão não funcionará.
                if (SUPABASE_URL === 'SUA_URL_DO_SUPABASE' || SUPABASE_ANON_KEY === 'SUA_CHAVE_ANONIMA') {
                    console.error("Por favor, substitua a URL e a chave do Supabase no código.");
                    showMessage("Erro: URL ou chave do Supabase inválida. Verifique o código.", 'error');
                    return;
                }
                supabase = createClient(SUPABASE_URL, SUPABASE_ANON_KEY);
                startApp();
            } catch (error) {
                console.error("Erro ao inicializar o Supabase:", error);
                showMessage("Erro ao conectar com o Supabase. Verifique o console.", 'error');
            }
        }
        
        async function startApp() {
            document.getElementById('loading').classList.add('hidden');
            document.getElementById('app-container').classList.remove('hidden');
            
            // Define o filtro inicial para o mês e ano atuais
            const today = new Date();
            document.getElementById('mes-filtro').value = today.getMonth() + 1;
            document.getElementById('ano-filtro').value = today.getFullYear();
            
            setupFilterListener();
            await checkAndAddPreviousMonthBalance();
            await fetchDataAndRenderAllTables();
            setupFormListeners();
        }
        
        async function checkAndAddPreviousMonthBalance() {
            const today = new Date();
            const mesAtual = today.getMonth() + 1;
            const anoAtual = today.getFullYear();

            // Verifica se é o primeiro dia do mês
            if (today.getDate() !== 1) {
                return;
            }

            // Calcula o mês e ano anteriores
            let mesAnterior = mesAtual === 1 ? 12 : mesAtual - 1;
            let anoAnterior = mesAtual === 1 ? anoAtual - 1 : anoAtual;
            
            // Corrige o problema do fuso horário usando o primeiro dia do próximo mês como limite
            const startDateAnterior = new Date(anoAnterior, mesAnterior - 1, 1).toISOString();
            const endDateAnterior = new Date(anoAtual, mesAtual - 1, 1).toISOString();

            // Verifica se o Saldo anterior já foi adicionado para o mês atual
            const { data: saldoExistente, error: checkError } = await supabase
                .from(tableNames.receitas)
                .select('id')
                .eq('tipo', 'Saldo anterior')
                .gte('created_at', new Date(anoAtual, mesAtual - 1, 1).toISOString())
                .lt('created_at', new Date(anoAtual, mesAtual, 1).toISOString());

            if (checkError) {
                console.error('Erro ao verificar saldo anterior:', checkError);
                return;
            }

            if (saldoExistente.length > 0) {
                // O saldo anterior já existe, não faz nada
                return;
            }

            // Busca os dados do mês anterior
            const { data: receitasAnterior } = await fetchData('receitas', startDateAnterior, endDateAnterior);
            const { data: despesasAnterior } = await fetchData('despesas', startDateAnterior, endDateAnterior);
            const { data: investimentosAnterior } = await fetchData('investimentos', startDateAnterior, endDateAnterior);
            
            // Calcula o saldo do mês anterior
            const totalReceitasAnterior = receitasAnterior.reduce((sum, item) => sum + item.valor, 0);
            const totalDespesasAnterior = despesasAnterior.reduce((sum, item) => sum + item.valor, 0);
            const totalInvestimentosAnterior = investimentosAnterior.reduce((sum, item) => sum + item.valor, 0);
            
            const saldoFinalAnterior = totalReceitasAnterior - totalDespesasAnterior - totalInvestimentosAnterior;

            // Insere o saldo final do mês anterior como uma nova receita
            const { error: insertError } = await supabase.from(tableNames.receitas).insert({
                descricao: 'Saldo do mês anterior',
                valor: saldoFinalAnterior,
                tipo: 'Saldo anterior'
            });

            if (insertError) {
                console.error('Erro ao adicionar saldo anterior:', insertError);
                showMessage('Erro ao adicionar saldo anterior. Tente novamente.', 'error');
            } else {
                showMessage('Saldo do mês anterior adicionado com sucesso!', 'success');
            }
        }

        function setupFilterListener() {
            const mesFiltro = document.getElementById('mes-filtro');
            const anoFiltro = document.getElementById('ano-filtro');
            
            const handleFilterChange = () => {
                fetchDataAndRenderAllTables();
            };
            
            mesFiltro.addEventListener('change', handleFilterChange);
            anoFiltro.addEventListener('input', handleFilterChange);

            // Adiciona listeners para os filtros da tabela unificada
            const registrosView = document.getElementById('registros-view');
            registrosView.querySelectorAll('.filter-input').forEach(input => {
                input.addEventListener('input', applyUnifiedFilters);
            });
            registrosView.querySelector('#tipo-registro').addEventListener('change', applyUnifiedFilters);
            registrosView.querySelector('#reset-unified-filters').addEventListener('click', () => {
                document.getElementById('tipo-registro').value = '';
                document.getElementById('filtro-descricao').value = '';
                document.getElementById('filtro-min-valor').value = '';
                document.getElementById('filtro-max-valor').value = '';
                document.getElementById('filtro-data').value = '';
                applyUnifiedFilters();
            });
        }
        
        // Função para aplicar os filtros na tabela unificada
        window.applyUnifiedFilters = () => {
            const tipoRegistro = document.getElementById('tipo-registro').value;
            const filtroDescricao = document.getElementById('filtro-descricao').value.toLowerCase();
            const filtroMinValor = parseFloat(document.getElementById('filtro-min-valor').value) || 0;
            const filtroMaxValor = parseFloat(document.getElementById('filtro-max-valor').value) || Infinity;
            const filtroData = document.getElementById('filtro-data').value;
            
            let filteredRecords = allRecords;

            if (tipoRegistro) {
                filteredRecords = filteredRecords.filter(item => item.collectionName === tipoRegistro);
            }

            filteredRecords = filteredRecords.filter(item => {
                const descricaoMatch = item.descricao.toLowerCase().includes(filtroDescricao);
                const valorMatch = item.valor >= filtroMinValor && item.valor <= filtroMaxValor;
                const dateMatch = !filtroData || new Date(item.created_at).toLocaleDateString().includes(filtroData);
                
                return descricaoMatch && valorMatch && dateMatch;
            });

            renderUnifiedTable(sortedItems(filteredRecords));
        };
        
        // Função para ordenar a tabela unificada
        window.sortTable = (column) => {
            if (sortState.column === column) {
                sortState.direction = sortState.direction === 'asc' ? 'desc' : 'asc';
            } else {
                sortState.column = column;
                sortState.direction = 'asc';
            }
            
            // Atualiza os ícones de ordenação
            document.querySelectorAll('#unified-table thead th .sort-icon').forEach(icon => {
                icon.textContent = '';
            });
            const sortIcon = document.getElementById(`sort-icon-${column}`);
            if (sortIcon) {
                sortIcon.textContent = sortState.direction === 'asc' ? '▲' : '▼';
            }
            
            applyUnifiedFilters();
        };

        function sortedItems(items) {
            return [...items].sort((a, b) => {
                let aValue = a[sortState.column];
                let bValue = b[sortState.column];

                if (sortState.column === 'created_at') {
                    aValue = new Date(aValue);
                    bValue = new Date(bValue);
                } else if (sortState.column === 'descricao') {
                    aValue = aValue.toLowerCase();
                    bValue = bValue.toLowerCase();
                }

                if (aValue < bValue) {
                    return sortState.direction === 'asc' ? -1 : 1;
                }
                if (aValue > bValue) {
                    return sortState.direction === 'asc' ? 1 : -1;
                }
                return 0;
            });
        }


        async function fetchDataAndRenderAllTables() {
            const collections = ['receitas', 'despesas', 'investimentos'];
            const mes = document.getElementById('mes-filtro').value;
            const ano = document.getElementById('ano-filtro').value;
            
            const startDate = new Date(ano, mes - 1, 1).toISOString();
            const endDate = new Date(ano, mes, 1).toISOString();
            
            let allData = [];

            for (const collectionName of collections) {
                const { data, error } = await fetchData(collectionName, startDate, endDate);
                if (error) {
                    console.error(`Erro ao obter dados de ${collectionName}:`, error);
                } else {
                    appData[collectionName] = data;
                    data.forEach(item => allData.push({ ...item, collectionName }));
                }
            }
            allRecords = allData;
            
            // Renderiza o dashboard e a tabela unificada
            updateDashboard();
            applyUnifiedFilters();
        }

        async function fetchData(collectionName, startDate, endDate) {
            const tableName = tableNames[collectionName];
            try {
                const { data, error } = await supabase
                    .from(tableName)
                    .select('*')
                    .gte('created_at', startDate)
                    .lt('created_at', endDate)
                    .order('created_at', { ascending: false });
                
                if (error) {
                    throw error;
                }
                return { data, error: null };
            } catch (error) {
                console.error(`Erro ao buscar dados de ${tableName}:`, error);
                return { data: null, error };
            }
        }

        function renderUnifiedTable(items) {
            const tableBody = document.getElementById('unified-table-body');
            tableBody.innerHTML = '';
            
            items.forEach(item => {
                const row = document.createElement('tr');
                row.className = 'border-b';
                
                let tipo = '';
                let valorCota = '';
                let cor = '';

                switch(item.collectionName) {
                    case 'receitas':
                        tipo = item.tipo || 'N/A';
                        cor = 'text-blue-500';
                        break;
                    case 'despesas':
                        tipo = 'Saída';
                        cor = 'text-red-500';
                        break;
                    case 'investimentos':
                        tipo = 'Investimento';
                        valorCota = `(${item.quantidade || 0} cotas)`;
                        cor = 'text-purple-500';
                        break;
                }
                
                row.innerHTML = `
                    <td class="p-2">${item.descricao}</td>
                    <td class="p-2 text-sm text-gray-500 ${cor}">${tipo} ${valorCota}</td>
                    <td class="p-2 text-sm text-gray-500">${new Date(item.created_at).toLocaleDateString()}</td>
                    <td class="p-2 text-right ${cor}">R$ ${item.valor.toFixed(2)}</td>
                    <td class="p-2 text-center flex justify-center space-x-2">
                        <button class="text-blue-500 hover:text-blue-700" onclick="handleEdit('${item.collectionName}', '${item.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path d="M13.586 3.586a2 2 0 112.828 2.828l-.793.793-2.828-2.828.793-.793zm-5.657 5.657l-1.414 1.414L3 13.586V16h2.414l5.657-5.657-2.828-2.828z" />
                            </svg>
                        </button>
                        <button class="text-red-500 hover:text-red-700" onclick="handleDelete('${item.collectionName}', '${item.id}')">
                            <svg xmlns="http://www.w3.org/2000/svg" class="h-5 w-5" viewBox="0 0 20 20" fill="currentColor">
                                <path fill-rule="evenodd" d="M9 2a1 1 0 00-.894.553L7.382 4H4a1 1 0 000 2v10a2 2 0 002 2h8a2 2 0 002-2V6a1 1 0 100-2h-3.382l-.724-1.447A1 1 0 0011 2H9zM7 8a1 1 0 012 0v6a1 1 0 11-2 0V8zm5-1a1 1 0 00-1 1v6a1 1 0 102 0V8a1 1 0 00-1-1z" clip-rule="evenodd" />
                            </svg>
                        </button>
                    </td>
                `;
                tableBody.appendChild(row);
            });
            document.getElementById('count-registros').textContent = `${items.length} itens`;
        }


        function setupFormListeners() {
            document.getElementById('form-dinamico').addEventListener('submit', handleFormSubmit);
        }
        
        window.updateDynamicForm = (tipoInsercao) => {
            const form = document.getElementById('form-dinamico');
            const valorInput = document.getElementById('valor-dinamico');
            const quantidadeInput = document.getElementById('quantidade-dinamico');
            const tipoReceitaSelect = document.getElementById('tipo-receita');
            
            // Remove a seleção de todos os botões e adiciona ao selecionado
            document.querySelectorAll('.btn-insercao').forEach(btn => {
                btn.classList.remove('bg-gray-300');
                btn.classList.add('bg-gray-200');
            });
            document.getElementById(`btn-${tipoInsercao}`).classList.remove('bg-gray-200');
            document.getElementById(`btn-${tipoInsercao}`).classList.add('bg-gray-300');


            // Resetar campos para evitar dados de formulário anteriores
            valorInput.placeholder = 'Valor (R$)';
            quantidadeInput.classList.add('hidden');
            tipoReceitaSelect.classList.add('hidden');

            // Ajustar o formulário com base no tipo de inserção
            if (tipoInsercao === 'receitas') {
                tipoReceitaSelect.classList.remove('hidden');
            } else if (tipoInsercao === 'investimentos') {
                quantidadeInput.classList.remove('hidden');
                valorInput.placeholder = 'Valor por Cota (R$)';
            }
            
            // Atualizar o nome da coleção no dataset do formulário para o submit
            form.dataset.collection = tipoInsercao;
        };

        // As funções handleEdit e handleDelete agora recebem a tabela e o ID
        window.handleEdit = async (collectionName, id) => {
            const form = document.getElementById('form-dinamico');
            const tableName = tableNames[collectionName];
            
            try {
                const { data, error } = await supabase.from(tableName).select('*').eq('id', id).single();
                if (error) {
                    console.error('Erro ao buscar item para edição:', error);
                    showMessage('Erro ao carregar item para edição.', 'error');
                    return;
                }
                
                window.updateDynamicForm(collectionName);

                document.getElementById('descricao-dinamico').value = data.descricao;
                if (collectionName === 'receitas') {
                    document.getElementById('valor-dinamico').value = data.valor;
                    document.getElementById('tipo-receita').value = data.tipo;
                } else if (collectionName === 'investimentos') {
                    document.getElementById('valor-dinamico').value = data.valor / data.quantidade;
                    document.getElementById('quantidade-dinamico').value = data.quantidade;
                } else { // Despesas
                    document.getElementById('valor-dinamico').value = data.valor;
                }
                
                form.dataset.itemId = id;
                form.querySelector('button[type="submit"]').textContent = 'Salvar Edição';
            } catch (error) {
                console.error('Erro ao buscar item para edição:', error);
                showMessage('Erro ao carregar item para edição.', 'error');
            }
        };
        
        window.handleDelete = async (collectionName, id) => {
             const customAlert = document.getElementById('custom-alert');
             const confirmBtn = document.getElementById('confirm-delete');
             const cancelBtn = document.getElementById('cancel-delete');

             customAlert.classList.remove('hidden');
             
             confirmBtn.onclick = async () => {
                customAlert.classList.add('hidden');
                const tableName = tableNames[collectionName];
                try {
                    const { error } = await supabase.from(tableName).delete().eq('id', id);
                    if (error) {
                        console.error('Erro ao deletar item:', error);
                        showMessage('Erro ao excluir item. Tente novamente.', 'error');
                        return;
                    }
                    showMessage('Item excluído com sucesso!', 'success');
                    fetchDataAndRenderAllTables(); // Atualiza os dados
                } catch (error) {
                    console.error('Erro ao deletar item:', error);
                    showMessage('Erro ao excluir item. Tente novamente.', 'error');
                }
             };

             cancelBtn.onclick = () => {
                customAlert.classList.add('hidden');
             };
        };

        async function handleFormSubmit(event) {
            event.preventDefault();
            const form = event.target;
            const collectionName = form.dataset.collection;
            const id = form.dataset.itemId;
            const tableName = tableNames[collectionName];

            const descricao = document.getElementById('descricao-dinamico').value;
            const valorInput = document.getElementById('valor-dinamico');
            const valor = parseFloat(valorInput.value);

            if (!descricao || isNaN(valor)) {
                showMessage('Por favor, preencha todos os campos.', 'error');
                return;
            }

            let item = { descricao, valor };
            
            if (collectionName === 'receitas') {
                const tipo = document.getElementById('tipo-receita').value;
                item.tipo = tipo;
            } else if (collectionName === 'investimentos') {
                const quantidade = parseFloat(document.getElementById('quantidade-dinamico').value);
                if (isNaN(quantidade) || quantidade <= 0) {
                    showMessage('Por favor, informe uma quantidade de cotas válida.', 'error');
                    return;
                }
                const valorPorCota = valor;
                item = {
                    descricao: descricao,
                    valor: valorPorCota * quantidade,
                    quantidade: quantidade
                };
            }

            try {
                if (id) {
                    const { error } = await supabase.from(tableName).update(item).eq('id', id);
                    if (error) throw error;
                    showMessage('Item atualizado com sucesso!', 'success');
                    form.removeAttribute('data-item-id');
                    form.querySelector('button[type="submit"]').textContent = 'Adicionar';
                } else {
                    const { error } = await supabase.from(tableName).insert([item]);
                    if (error) throw error;
                    showMessage('Item adicionado com sucesso!', 'success');
                }
                form.reset();
                window.updateDynamicForm('receitas');
                fetchDataAndRenderAllTables(); // Atualiza os dados
            } catch (error) {
                console.error(`Erro ao salvar item em ${tableName}:`, error);
                showMessage('Erro ao salvar item. Tente novamente.', 'error');
            }
        }

        function renderTable(collectionName, items) {
            let total = 0;
            items.forEach(item => {
                total += item.valor;
            });

            document.getElementById(`total-${collectionName}`).textContent = `R$ ${total.toFixed(2)}`;
            updateDashboard();
        }

        function updateDashboard() {
            const totalReceitas = appData.receitas.reduce((sum, item) => sum + item.valor, 0);
            const totalDespesas = appData.despesas.reduce((sum, item) => sum + item.valor, 0);
            const totalInvestimentos = appData.investimentos.reduce((sum, item) => sum + item.valor, 0);

            document.getElementById('total-receitas').textContent = `R$ ${totalReceitas.toFixed(2)}`;
            document.getElementById('total-despesas').textContent = `R$ ${totalDespesas.toFixed(2)}`;
            document.getElementById('total-investimentos').textContent = `R$ ${totalInvestimentos.toFixed(2)}`;

            const saldo = totalReceitas - totalDespesas - totalInvestimentos;
            const saldoElement = document.getElementById('saldo-final');
            
            saldoElement.textContent = `R$ ${saldo.toFixed(2)}`;
            saldoElement.classList.remove('text-green-600', 'text-red-600');
            saldoElement.classList.add(saldo >= 0 ? 'text-green-600' : 'text-red-600');
        }
        
        function showMessage(message, type) {
            const messageBox = document.getElementById('message-box');
            messageBox.textContent = message;
            messageBox.className = `fixed bottom-4 right-4 p-4 rounded-lg shadow-lg text-white ${type === 'success' ? 'bg-green-500' : 'bg-red-500'} transition-opacity duration-300`;
            messageBox.classList.remove('opacity-0');
            setTimeout(() => {
                messageBox.classList.add('opacity-0');
            }, 3000);
        }

        // NOVO: Função para alternar entre as visualizações
        window.toggleView = () => {
            const formsView = document.getElementById('forms-view');
            const registrosView = document.getElementById('registros-view');
            const toggleBtn = document.getElementById('toggle-view-btn');

            if (registrosView.classList.contains('hidden')) {
                formsView.classList.add('hidden');
                registrosView.classList.remove('hidden');
                toggleBtn.textContent = 'Voltar ao Resumo';
            } else {
                formsView.classList.remove('hidden');
                registrosView.classList.add('hidden');
                toggleBtn.textContent = 'Ver Registros';
            }
        };

        document.addEventListener('DOMContentLoaded', () => {
            initializeSupabase();
            window.updateDynamicForm('receitas');
        });
    </script>
    <style>
        body {
            font-family: 'Inter', sans-serif;
        }
    </style>
</head>
<body class="bg-gray-100 min-h-screen p-4 sm:p-8">
    
    <div id="loading" class="flex justify-center items-center h-screen">
        <div class="animate-spin rounded-full h-16 w-16 border-t-2 border-b-2 border-gray-900"></div>
    </div>
    
    <div id="app-container" class="hidden">
        <header class="text-center mb-8">
            <h1 class="text-4xl sm:text-5xl font-extrabold text-gray-800">Controle Financeiro</h1>
            <p class="mt-2 text-lg text-gray-600">Organize suas finanças com facilidade.</p>
        </header>

        <!-- Filtro de Mês e Ano -->
        <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
            <h2 class="text-2xl font-bold text-gray-700 mb-4">Filtrar por Período</h2>
            <div class="flex flex-col sm:flex-row items-center space-y-4 sm:space-y-0 sm:space-x-4 mb-8">
                <select id="mes-filtro" class="p-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
                    <option value="1">Janeiro</option>
                    <option value="2">Fevereiro</option>
                    <option value="3">Março</option>
                    <option value="4">Abril</option>
                    <option value="5">Maio</option>
                    <option value="6">Junho</option>
                    <option value="7">Julho</option>
                    <option value="8">Agosto</option>
                    <option value="9">Setembro</option>
                    <option value="10">Outubro</option>
                    <option value="11">Novembro</option>
                    <option value="12">Dezembro</option>
                </select>
                <input type="number" id="ano-filtro" placeholder="Ano" class="p-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400 w-32">
            </div>

            <!-- Resumo do Mês -->
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Resumo do Mês</h2>
                <div class="flex flex-col sm:flex-row justify-around text-center space-y-4 sm:space-y-0 sm:space-x-4">
                    <div class="p-4 bg-blue-100 rounded-xl flex-1">
                        <p class="text-sm text-blue-700">Entradas</p>
                        <p id="total-receitas" class="text-2xl font-bold text-blue-900">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-red-100 rounded-xl flex-1">
                        <p class="text-sm text-red-700">Saídas</p>
                        <p id="total-despesas" class="text-2xl font-bold text-red-900">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-purple-100 rounded-xl flex-1">
                        <p class="text-sm text-purple-700">Investimentos</p>
                        <p id="total-investimentos" class="text-2xl font-bold text-purple-900">R$ 0,00</p>
                    </div>
                    <div class="p-4 bg-green-100 rounded-xl flex-1">
                        <p class="text-sm text-green-700">Saldo Final</p>
                        <p id="saldo-final" class="text-2xl font-bold text-green-900">R$ 0,00</p>
                    </div>
                </div>
            </div>

            <!-- Botão de Alternância -->
            <div class="mt-4 text-center">
                <button id="toggle-view-btn" onclick="toggleView()" class="p-2 rounded-xl bg-gray-200 text-gray-700 font-semibold hover:bg-gray-300 transition-colors">Ver Registros</button>
            </div>
        </div>

        <!-- Forms View -->
        <div id="forms-view" class="">
            <!-- Formulário Dinâmico -->
            <div class="bg-white p-6 rounded-2xl shadow-lg mb-8">
                <h2 class="text-2xl font-bold text-gray-700 mb-4">Adicionar Item</h2>
                <!-- Botões de seleção de tipo -->
                <div class="flex justify-around mb-4">
                    <button id="btn-receitas" class="btn-insercao p-4 rounded-xl flex-1 mx-1 text-center bg-gray-200 hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-blue-400" onclick="updateDynamicForm('receitas')">
                        <svg class="h-8 w-8 text-blue-500 mx-auto" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 4V20M4 12H20" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <p class="text-sm mt-1">Entrada</p>
                    </button>
                    <button id="btn-despesas" class="btn-insercao p-4 rounded-xl flex-1 mx-1 text-center bg-gray-200 hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-red-400" onclick="updateDynamicForm('despesas')">
                        <svg class="h-8 w-8 text-red-500 mx-auto" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M6 12H18" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <p class="text-sm mt-1">Saída</p>
                    </button>
                    <button id="btn-investimentos" class="btn-insercao p-4 rounded-xl flex-1 mx-1 text-center bg-gray-200 hover:bg-gray-300 transition-colors focus:outline-none focus:ring-2 focus:ring-purple-400" onclick="updateDynamicForm('investimentos')">
                        <svg class="h-8 w-8 text-purple-500 mx-auto" viewBox="0 0 24 24" fill="none" xmlns="http://www.w3.org/2000/svg">
                            <path d="M12 2L2 12L12 22L22 12L12 2ZM12 16L6 12L12 8L18 12L12 16Z" stroke="currentColor" stroke-width="2" stroke-linecap="round" stroke-linejoin="round"/>
                        </svg>
                        <p class="text-sm mt-1">Investimento</p>
                    </button>
                </div>
                
                <form id="form-dinamico" data-collection="receitas">
                    <div class="flex flex-col space-y-2">
                        <input type="text" id="descricao-dinamico" placeholder="Descrição" required class="p-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <select id="tipo-receita" required class="hidden p-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
                            <option value="">Selecione o Tipo da Entrada</option>
                            <option value="Saldo anterior">Saldo anterior</option>
                            <option value="1° Salario - 15">1° Salário - 15</option>
                            <option value="2° Salário - 30">2° Salário - 30</option>
                            <option value="Dividendos">Dividendos</option>
                            <option value="Pix">Pix</option>
                            <option value="Crédito">Crédito</option>
                        </select>
                        <input type="number" id="valor-dinamico" placeholder="Valor (R$)" step="0.01" required class="p-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <input type="number" id="quantidade-dinamico" placeholder="Quantidade de Cotas" value="1" step="0.01" min="0" required class="hidden p-2 rounded-xl border border-gray-300 focus:outline-none focus:ring-2 focus:ring-blue-400">
                        <button type="submit" class="p-2 bg-blue-500 text-white rounded-xl font-semibold hover:bg-blue-600 transition-colors">Adicionar</button>
                    </div>
                </form>
            </div>
        </div>

        <!-- REGISTROS VIEW (Hidden by default) -->
        <div id="registros-view" class="hidden">
            <!-- Tabela de Registros Unificada -->
            <div class="bg-white p-6 rounded-2xl shadow-lg">
                <h2 class="2xl font-bold text-gray-700 mb-4">Registros do Mês</h2>
                <div id="filter-form-unified" class="bg-gray-50 p-4 rounded-xl mb-4">
                    <p class="font-bold text-sm text-gray-700 mb-2">Filtros:</p>
                    <div class="grid grid-cols-2 sm:grid-cols-3 gap-2">
                        <select id="tipo-registro" class="p-1 text-sm rounded border" data-collection="unified">
                            <option value="">Todos os Registros</option>
                            <option value="receitas">Entradas</option>
                            <option value="despesas">Saídas</option>
                            <option value="investimentos">Investimentos</option>
                        </select>
                        <input type="text" id="filtro-descricao" data-filter="descricao" placeholder="Descrição" class="filter-input p-1 text-sm rounded border" data-collection="unified">
                        <input type="text" id="filtro-data" data-filter="data" placeholder="dd/mm/aaaa" class="filter-input p-1 text-sm rounded border" data-collection="unified">
                        <input type="number" id="filtro-min-valor" data-filter="min-valor" placeholder="Valor Mínimo" step="0.01" class="filter-input p-1 text-sm rounded border" data-collection="unified">
                        <input type="number" id="filtro-max-valor" data-filter="max-valor" placeholder="Valor Máximo" step="0.01" class="filter-input p-1 text-sm rounded border" data-collection="unified">
                        <button id="reset-unified-filters" class="col-span-2 sm:col-span-3 p-1 bg-gray-200 text-gray-700 rounded-xl hover:bg-gray-300 text-sm">Limpar Filtros</button>
                    </div>
                </div>
                <div class="max-h-96 overflow-y-auto">
                    <table class="min-w-full" id="unified-table">
                        <thead class="sticky top-0 bg-white">
                            <tr>
                                <th class="p-2 text-left text-sm font-semibold text-gray-600 cursor-pointer" onclick="sortTable('descricao')">Descrição
                                    <span class="sort-icon ml-1" id="sort-icon-descricao"></span>
                                </th>
                                <th class="p-2 text-left text-sm font-semibold text-gray-600">Tipo</th>
                                <th class="p-2 text-left text-sm font-semibold text-gray-600 cursor-pointer" onclick="sortTable('created_at')">Data
                                    <span class="sort-icon ml-1" id="sort-icon-created_at"></span>
                                </th>
                                <th class="p-2 text-right text-sm font-semibold text-gray-600 cursor-pointer" onclick="sortTable('valor')">Valor
                                    <span class="sort-icon ml-1" id="sort-icon-valor"></span>
                                </th>
                                <th class="p-2 text-center text-sm font-semibold text-gray-600">Ações</th>
                            </tr>
                        </thead>
                        <tbody id="unified-table-body" class="divide-y divide-gray-200">
                        </tbody>
                    </table>
                </div>
                <div class="text-sm font-semibold text-gray-700 mt-2">
                    <span id="count-registros">0 itens</span>
                </div>
            </div>
        </div>
    </div>
    
    <!-- Caixa de Mensagem (Toast) -->
    <div id="message-box" class="opacity-0"></div>

    <!-- Modal de Confirmação de Exclusão (Substitui o alert/confirm) -->
    <div id="custom-alert" class="hidden fixed inset-0 bg-gray-600 bg-opacity-50 flex items-center justify-center p-4">
        <div class="bg-white rounded-xl p-6 shadow-xl text-center max-w-sm w-full">
            <h3 class="text-lg font-bold mb-4">Confirmar Exclusão</h3>
            <p class="mb-6">Tem certeza que deseja excluir este item? Esta ação não pode ser desfeita.</p>
            <div class="flex justify-center space-x-4">
                <button id="cancel-delete" class="px-4 py-2 bg-gray-200 text-gray-800 rounded-lg hover:bg-gray-300 transition-colors">Cancelar</button>
                <button id="confirm-delete" class="px-4 py-2 bg-red-500 text-white rounded-lg hover:bg-red-600 transition-colors">Excluir</button>
            </div>
        </div>
    </div>
</body>
</html>
